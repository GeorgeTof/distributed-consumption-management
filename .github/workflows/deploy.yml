name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # These match your FOLDER names (CamelCase is fine here)
        service: [AuthService, DeviceService, MonitorService, UserService, LoadBalancer, WebsocketService, frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Using Java 21 LTS is safer than 25 (EA), unless you specifically need 25 features
    - name: Set up JDK 21
      if: matrix.service != 'frontend'
      uses: actions/setup-java@v4
      with:
        java-version: '21' 
        distribution: 'temurin' 
        cache: maven

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Test (Java)
      if: matrix.service != 'frontend'
      run: |
        cd ${{ matrix.service }}
        mvn package -DskipTests

    - name: Build and Push Docker Image
      run: |
        # 1. Convert service name to LOWERCASE for the Docker Image Tag
        # 'tr' translates Upper to Lower
        LOWERCASE_SERVICE=$(echo "${{ matrix.service }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_TAG=${{ secrets.DOCKER_USERNAME }}/${LOWERCASE_SERVICE}:latest

        echo "Building image: $IMAGE_TAG using folder: ${{ matrix.service }}"

        # 2. Go to the actual folder (Keep CamelCase here!)
        cd ${{ matrix.service }}
        
        # 3. Build Logic
        if [ "${{ matrix.service }}" == "frontend" ]; then
          docker build --build-arg REACT_APP_BACKEND_HOST=/ -t $IMAGE_TAG .
        else
          docker build -t $IMAGE_TAG .
        fi
        
        docker push $IMAGE_TAG

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Fix: Ensure the target directory exists on Azure before copying
    - name: Create directory on VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: mkdir -p /home/${{ secrets.SSH_USERNAME }}/distributed-project

    - name: Copy config files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "./docker-compose.yaml,./traefik.yml,./dynamic/"
        target: "/home/${{ secrets.SSH_USERNAME }}/distributed-project"

    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.SSH_USERNAME }}/distributed-project
          
          # Fix: Create the network if it doesn't exist
          docker network inspect demo_net >/dev/null 2>&1 || docker network create demo_net
          
          # Login to pull private images
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          
          # Pull and Up
          docker compose pull
          docker compose up -d --remove-orphans