name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  DEPLOY_HOST: ${{ secrets.SSH_HOST }}

jobs:
  # ============================================
  # STAGE 1: BUILD & PUSH DOCKER IMAGES
  # ============================================
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: AuthService
            image_name: authservice
          - service: DeviceService
            image_name: deviceservice
          - service: MonitorService
            image_name: monitorservice
          - service: UserService
            image_name: userservice
          - service: LoadBalancer
            image_name: loadbalancer
          - service: WebsocketService
            image_name: websocketservice
          - service: frontend
            image_name: frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      if: matrix.service != 'frontend'
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin' 
        cache: maven

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Test (Java)
      if: matrix.service != 'frontend'
      run: |
        set -e
        echo "Building ${{ matrix.service }}..."
        cd ${{ matrix.service }}
        mvn package -DskipTests -B
        echo "Build completed successfully"

    - name: Build and Push Docker Image
      run: |
        set -e
        cd ${{ matrix.service }}
        
        IMAGE_TAG=${{ secrets.DOCKER_USERNAME }}/${{ matrix.image_name }}:latest
        IMAGE_TAG_SHA=${{ secrets.DOCKER_USERNAME }}/${{ matrix.image_name }}:${{ github.sha }}
        
        echo "Building image: $IMAGE_TAG"
        
        if [ "${{ matrix.service }}" == "frontend" ]; then
          docker build --build-arg REACT_APP_BACKEND_HOST=/ -t $IMAGE_TAG -t $IMAGE_TAG_SHA .
        else
          docker build -t $IMAGE_TAG -t $IMAGE_TAG_SHA .
        fi
        
        docker push $IMAGE_TAG
        docker push $IMAGE_TAG_SHA
        
        echo "Successfully pushed $IMAGE_TAG"

  # ============================================
  # STAGE 2: DEPLOY TO AZURE VM
  # ============================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy config files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "docker-compose.yaml,traefik.yml,dynamic/"
        target: "/home/${{ secrets.SSH_USERNAME }}/distributed-project"

    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e
          
          echo "=== Starting deployment ==="
          cd /home/${{ secrets.SSH_USERNAME }}/distributed-project
          
          echo "=== Logging into Docker Hub ==="
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          
          echo "=== Creating network if not exists ==="
          docker network create demo_net 2>/dev/null || echo "Network already exists"
          
          echo "=== Pulling new images ==="
          docker compose pull
          
          echo "=== Starting containers ==="
          docker compose up -d --remove-orphans
          
          echo "=== Deployment complete ==="

  # ============================================
  # STAGE 3: SMOKE TESTS
  # ============================================
  smoke-tests:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
    - name: Wait for services to stabilize
      run: |
        echo "Waiting 60 seconds for all services to start..."
        sleep 60

    - name: Check containers are running
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e
          echo "=== Checking container status ==="
          cd /home/${{ secrets.SSH_USERNAME }}/distributed-project
          
          # Get list of expected services
          EXPECTED_CONTAINERS=(
            "traefik"
            "rabbitmq"
            "rabbitmq-internal"
            "users-db"
            "devices-db"
            "auth-db"
            "monitor-db"
            "user-service"
            "device-service"
            "auth-service"
            "monitor-service"
            "monitor-service-2"
            "monitor-service-3"
            "load-balancer"
            "websocket-service"
            "frontend-service"
          )
          
          FAILED=0
          
          for container in "${EXPECTED_CONTAINERS[@]}"; do
            STATUS=$(docker inspect -f '{{.State.Status}}' "$container" 2>/dev/null || echo "not_found")
            if [ "$STATUS" == "running" ]; then
              echo "‚úÖ $container: running"
            else
              echo "‚ùå $container: $STATUS"
              FAILED=1
            fi
          done
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "=== Container logs for failed services ==="
            docker compose ps -a
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All containers are running!"

    - name: Check database connections
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e
          echo "=== Checking database health ==="
          
          DATABASES=("users-db" "devices-db" "auth-db" "monitor-db")
          
          for db in "${DATABASES[@]}"; do
            if docker exec "$db" pg_isready -U postgres > /dev/null 2>&1; then
              echo "‚úÖ $db: PostgreSQL is ready"
            else
              echo "‚ùå $db: PostgreSQL is NOT ready"
              exit 1
            fi
          done
          
          echo ""
          echo "‚úÖ All databases are healthy!"

    - name: Check RabbitMQ connections
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e
          echo "=== Checking RabbitMQ health ==="
          
          # Check main RabbitMQ
          if docker exec rabbitmq rabbitmq-diagnostics check_running > /dev/null 2>&1; then
            echo "‚úÖ rabbitmq: Running"
          else
            echo "‚ùå rabbitmq: NOT running"
            exit 1
          fi
          
          # Check internal RabbitMQ
          if docker exec rabbitmq-internal rabbitmq-diagnostics check_running > /dev/null 2>&1; then
            echo "‚úÖ rabbitmq-internal: Running"
          else
            echo "‚ùå rabbitmq-internal: NOT running"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All message brokers are healthy!"

    - name: Check HTTP endpoints
      run: |
        set -e
        echo "=== Checking HTTP endpoints ==="
        
        BASE_URL="http://${{ secrets.SSH_HOST }}"
        
        # Function to check endpoint
        check_endpoint() {
          local name=$1
          local url=$2
          local expected_code=${3:-200}
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$url" || echo "000")
          
          if [ "$HTTP_CODE" == "$expected_code" ]; then
            echo "‚úÖ $name: HTTP $HTTP_CODE"
            return 0
          else
            echo "‚ùå $name: HTTP $HTTP_CODE (expected $expected_code)"
            return 1
          fi
        }
        
        FAILED=0
        
        # Check frontend
        check_endpoint "Frontend" "$BASE_URL/" || FAILED=1
        
        # Check auth login endpoint (public, should return 405 for GET or 200)
        # We use POST check or just verify it doesn't 404/502
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$BASE_URL/auth/login" || echo "000")
        if [ "$HTTP_CODE" != "000" ] && [ "$HTTP_CODE" != "502" ] && [ "$HTTP_CODE" != "503" ] && [ "$HTTP_CODE" != "504" ]; then
          echo "‚úÖ Auth Login Endpoint: HTTP $HTTP_CODE (service reachable)"
        else
          echo "‚ùå Auth Login Endpoint: HTTP $HTTP_CODE (service not reachable)"
          FAILED=1
        fi
        
        # Check Traefik dashboard
        check_endpoint "Traefik Dashboard" "$BASE_URL:8080/dashboard/" "200" || FAILED=1
        
        if [ $FAILED -eq 1 ]; then
          echo ""
          echo "‚ùå Some HTTP checks failed!"
          exit 1
        fi
        
        echo ""
        echo "‚úÖ All HTTP endpoints are reachable!"

    - name: Test auth login flow
      run: |
        set -e
        echo "=== Testing authentication flow ==="
        
        BASE_URL="http://${{ secrets.SSH_HOST }}"
        
        # Test login with default admin credentials
        # Adjust these credentials to match your default test user
        RESPONSE=$(curl -s -X POST "$BASE_URL/auth/login" \
          -H "Content-Type: application/json" \
          -d '{"username":"admin","password":"admin"}' \
          --max-time 15)
        
        echo "Login response: $RESPONSE"
        
        # Check if we got a token back (adjust based on your API response format)
        if echo "$RESPONSE" | grep -q "token\|jwt\|access"; then
          echo "‚úÖ Authentication flow working - received token"
        elif echo "$RESPONSE" | grep -qi "error\|invalid\|unauthorized"; then
          echo "‚ö†Ô∏è  Login returned error (might be expected if no default user exists)"
          echo "   Response: $RESPONSE"
          # Don't fail - credentials might just be wrong
        else
          echo "‚ö†Ô∏è  Unexpected response format"
          echo "   Response: $RESPONSE"
        fi
        
        echo ""
        echo "‚úÖ Auth service is responding!"

    - name: Print deployment summary
      if: always()
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "=========================================="
          echo "         DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          echo "üìç Application URL: http://${{ secrets.SSH_HOST }}"
          echo "üìä Traefik Dashboard: http://${{ secrets.SSH_HOST }}:8080"
          echo "üê∞ RabbitMQ Management: http://${{ secrets.SSH_HOST }}:15672"
          echo ""
          echo "=== Container Status ==="
          cd /home/${{ secrets.SSH_USERNAME }}/distributed-project
          docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "=== Resource Usage ==="
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"