name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  # Define image names in lowercase (Docker Hub requirement)
  REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue other builds even if one fails
      matrix:
        include:
          - service: AuthService
            image_name: authservice
          - service: DeviceService
            image_name: deviceservice
          - service: MonitorService
            image_name: monitorservice
          - service: UserService
            image_name: userservice
          - service: LoadBalancer
            image_name: loadbalancer
          - service: WebsocketService
            image_name: websocketservice
          - service: frontend
            image_name: frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      if: matrix.service != 'frontend'
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin' 
        cache: maven

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Test (Java)
      if: matrix.service != 'frontend'
      run: |
        set -e  # Exit on error
        echo "Building ${{ matrix.service }}..."
        cd ${{ matrix.service }}
        mvn package -DskipTests -B  # -B for batch mode (less verbose but cleaner logs)
        echo "Build completed successfully"

    - name: Build and Push Docker Image
      run: |
        set -e  # Exit on error
        cd ${{ matrix.service }}
        
        # Use lowercase image name
        IMAGE_TAG=${{ secrets.DOCKER_USERNAME }}/${{ matrix.image_name }}:latest
        IMAGE_TAG_SHA=${{ secrets.DOCKER_USERNAME }}/${{ matrix.image_name }}:${{ github.sha }}
        
        echo "Building image: $IMAGE_TAG"
        
        if [ "${{ matrix.service }}" == "frontend" ]; then
          docker build --build-arg REACT_APP_BACKEND_HOST=/ -t $IMAGE_TAG -t $IMAGE_TAG_SHA .
        else
          docker build -t $IMAGE_TAG -t $IMAGE_TAG_SHA .
        fi
        
        echo "Pushing image: $IMAGE_TAG"
        docker push $IMAGE_TAG
        docker push $IMAGE_TAG_SHA
        
        echo "Successfully pushed $IMAGE_TAG"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy config files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "docker-compose.yaml,traefik.yml,dynamic/"
        target: "/home/${{ secrets.SSH_USERNAME }}/distributed-project"
        debug: true  # Enable debug logging

    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        debug: true  # Enable debug logging
        script: |
          set -e  # Exit on any error
          
          echo "=== Starting deployment ==="
          cd /home/${{ secrets.SSH_USERNAME }}/distributed-project
          
          echo "=== Logging into Docker Hub ==="
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          
          echo "=== Creating network if not exists ==="
          docker network create demo_net 2>/dev/null || echo "Network already exists"
          
          echo "=== Pulling new images ==="
          docker compose pull
          
          echo "=== Starting containers ==="
          docker compose up -d --remove-orphans
          
          echo "=== Deployment complete ==="
          docker compose ps