name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # frontend is included but handled differently in the steps below
        service: [AuthService, DeviceService, MonitorService, UserService, LoadBalancer, WebsocketService, frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      if: matrix.service != 'frontend'
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin' 
        cache: maven

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Java Build (Maven) - Skips for Frontend
    - name: Build and Test (Java)
      if: matrix.service != 'frontend'
      run: |
        cd ${{ matrix.service }}
        mvn package -DskipTests

    # 2. Docker Build & Push
    - name: Build and Push Docker Image
      run: |
        cd ${{ matrix.service }}
        
        # We define the image tag
        IMAGE_TAG=${{ secrets.DOCKER_USERNAME }}/${{ matrix.service }}:latest
        
        # Logic: If it's frontend, we pass the build-arg. If not, standard build.
        if [ "${{ matrix.service }}" == "frontend" ]; then
          docker build --build-arg REACT_APP_BACKEND_HOST=/ -t $IMAGE_TAG .
        else
          docker build -t $IMAGE_TAG .
        fi
        
        docker push $IMAGE_TAG

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy config files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        # copy the compose file, traefik config, and dynamic config
        source: "./docker-compose.yaml,./traefik.yml,./dynamic/"
        target: "/home/${{ secrets.SSH_USERNAME }}/distributed-project"

    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/${{ secrets.SSH_USERNAME }}/distributed-project
          
          # Login to pull private images
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          
          # Pull new images and restart containers
          docker compose pull
          docker compose up -d --remove-orphans