services:
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: always
    ports:
      - "80:80"       # HTTP
      - "8080:8080"   # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./dynamic:/etc/traefik/dynamic:ro
      - traefik_logs:/var/log/traefik
      - ./plugins-storage:/plugins-storage
    networks:
      demo_net:

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    restart: always
    ports:
      - "5672:5672"     # Exposed for Desktop Simulator
      - "15672:15672"   # Management Dashboard
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      demo_net:

  rabbitmq-internal:
    image: rabbitmq:3-management
    container_name: rabbitmq-internal
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5673:5672"   
      - "15673:15672"   # Management Dashboard
    networks:
      demo_net:

  users-db:
    image: postgres
    container_name: users-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: users-db
    volumes:
      - users-data:/var/lib/postgresql/data
    networks:
      demo_net:

  devices-db:
    image: postgres
    container_name: devices-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: devices-db
    volumes:
      - devices-data:/var/lib/postgresql/data
    networks:
      demo_net:

  auth-db:
    image: postgres
    container_name: auth-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: auth-db
    volumes:
      - auth-data:/var/lib/postgresql/data
    networks:
      demo_net:

  monitor-db:
    image: postgres
    container_name: monitor-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: monitor-db
    volumes:
      - monitor-data:/var/lib/postgresql/data
    networks:
      demo_net:

  # --- MICROSERVICES (Updated to Lowercase Docker Hub Images) ---

  user-service:
    image: georgetof/userservice:latest 
    container_name: user-service
    restart: always
    environment:
      - DB_IP=users-db
      - DB_PORT=5432
      - DB_DBNAME=users-db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - RABBIT_HOST=rabbitmq-internal
      - RABBIT_PORT=5672
    depends_on:
      - users-db
      - rabbitmq-internal
    networks:
      demo_net:

  device-service:
    image: georgetof/deviceservice:latest
    container_name: device-service
    restart: always
    environment:
      - DB_IP=devices-db
      - DB_PORT=5432
      - DB_DBNAME=devices-db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - RABBIT_HOST=rabbitmq-internal
      - RABBIT_PORT=5672
    depends_on:
      - devices-db
      - rabbitmq-internal
    networks:
      demo_net:

  auth-service: 
    image: georgetof/authservice:latest
    container_name: auth-service
    restart: always
    environment:
      - DB_IP=auth-db
      - DB_PORT=5432
      - DB_DBNAME=auth-db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - PORT=8081
    depends_on:
      - auth-db
    networks:
      demo_net:

  monitor-service:
    image: georgetof/monitorservice:latest
    container_name: monitor-service
    restart: always
    environment:
      - DB_IP=monitor-db
      - DB_PORT=5432
      - DB_DBNAME=monitor-db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - RABBIT_SENSOR_HOST=rabbitmq
      - RABBIT_SENSOR_PORT=5672
      - RABBIT_INTERNAL_HOST=rabbitmq-internal
      - RABBIT_INTERNAL_PORT=5672
      - PORT=8080
      - INSTANCE_INDEX=0 
    depends_on:
      - monitor-db
      - rabbitmq
      - rabbitmq-internal
      - load-balancer
    networks:
      demo_net:

  monitor-service-2:
    image: georgetof/monitorservice:latest
    container_name: monitor-service-2
    restart: always
    environment:
      - DB_IP=monitor-db
      - DB_PORT=5432
      - DB_DBNAME=monitor-db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - RABBIT_SENSOR_HOST=rabbitmq
      - RABBIT_SENSOR_PORT=5672
      - RABBIT_INTERNAL_HOST=rabbitmq-internal
      - RABBIT_INTERNAL_PORT=5672
      - PORT=8080
      - INSTANCE_INDEX=1
    depends_on:
      - monitor-db
      - rabbitmq
      - rabbitmq-internal
      - load-balancer
    networks:
      demo_net:

  monitor-service-3:
    image: georgetof/monitorservice:latest
    container_name: monitor-service-3
    restart: always
    environment:
      - DB_IP=monitor-db
      - DB_PORT=5432
      - DB_DBNAME=monitor-db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - RABBIT_SENSOR_HOST=rabbitmq
      - RABBIT_SENSOR_PORT=5672
      - RABBIT_INTERNAL_HOST=rabbitmq-internal
      - RABBIT_INTERNAL_PORT=5672
      - PORT=8080
      - INSTANCE_INDEX=2
    depends_on:
      - monitor-db
      - rabbitmq
      - rabbitmq-internal
      - load-balancer
    networks:
      demo_net:

  load-balancer:
    image: georgetof/loadbalancer:latest
    container_name: load-balancer
    restart: always
    environment:
      - RABBIT_HOST=rabbitmq
      - RABBIT_PORT=5672
      - MONITOR_INSTANCES_COUNT=3
    depends_on:
      - rabbitmq
    networks:
      demo_net:

  websocket-service:
    image: georgetof/websocketservice:latest
    container_name: websocket-service
    restart: always
    ports:
      - "8082:8080"
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - PORT=8080
      - RABBIT_INTERNAL_HOST=rabbitmq-internal
      - RABBIT_INTERNAL_PORT=5672
      - APP_QUEUE_NAME=overconsumption.queue
    depends_on:
      - rabbitmq-internal
    networks:
      demo_net:

  frontend:
    image: georgetof/frontend:latest
    container_name: frontend-service 
    restart: unless-stopped
    depends_on:
      - traefik
      - auth-service
      - user-service
      - device-service
    networks:
      - demo_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`localhost`) && PathPrefix(`/`)"
      - "traefik.http.routers.frontend.priority=1" 
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

volumes:
  users-data:
  devices-data:
  traefik_logs:
  auth-data:
  monitor-data:

networks:
  demo_net:
    external: true